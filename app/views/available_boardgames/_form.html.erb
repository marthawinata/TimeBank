<%= form_for(@available_boardgame) do |f| %>
  <% if @available_boardgame.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@available_boardgame.errors.count, "error") %> prohibited this available_boardgame from being saved:</h2>

      <ul>
      <% @available_boardgame.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

    <ul data-role="listview" id="selected_boardgames">
      <% @owned_boardgames.each do |owned_boardgame| %>
        <%
          selected = @selected_boardgame_ids.include? owned_boardgame.id
          icon = selected ? "check" : "delete"
          link = selected ? "delete-game" : "add-game"
        %>
	<li data-icon="<%= icon %>" data-theme="c">
          <a href="#" data-action="<%= link %>" data-boardgame-id="<%= owned_boardgame.id  %>"><img src="/images/logo.jpg" /><h3><%= owned_boardgame.name %></h3></a>
          <!--<img src="/images/logo.jpg" /><%= owned_boardgame.name %> -->
          <!-- <a href="#" data-action="<%= link %>"></a> -->
        </li>
      <% end %>
    </ul>

  <%= f.hidden_field :meetup_id, :value => @available_boardgame.meetup_id %>
  <br/>
  <div class="actions">
    <%= f.submit %>
  </div>

<% end %>

<script type="text/javascript">
  $(function(){
    $('ul[data-role="listview"]').delegate('a[data-action="add-game"]', 'click', function(){
      var item = $(this).attr('data-action', 'delete-game')
        .closest('li').attr('data-icon', 'check')
        .find('.ui-icon').removeClass('ui-icon-delete').addClass('ui-icon-check');
    });
    $('ul[data-role="listview"]').delegate('a[data-action="delete-game"]', 'click', function(){
      var item = $(this).attr('data-action', 'add-game')
        .closest('li').attr('data-icon', 'delete')
        .find('.ui-icon').removeClass('ui-icon-check').addClass('ui-icon-delete');
    });
    $('#new_available_boardgame').submit(function(e){
      var form = $(this),
          boardgame_select = $('<select id="boardgame_id_select" name="available_boardgame[boardgame_id][]" style="display:none" data-role="none" multiple="multiple"></select>');
          
      $('#boardgame_id_select').remove();
      $('li a[data-action="delete-game"]').each(function(index, elt) {
        var id = $(this).attr('data-boardgame-id');
        boardgame_select
          .append('<option selected="selected" value="' + id + '">' + id + '</option>');

      });
      form.append(boardgame_select);
    });
    $('#available-boardgames-search-area').delegate('.search-boardgame-add', 'click', function(){
      var row = $(this).closest('.search-boardgame-row'),
      name = row.find('.search-boardgame-name').text(),
        id = row.attr('data-boardgame-id');
      $('#selected_boardgames')
        .append('<li data-icon="check" data-theme="c"><a href="#" data-action="delete-game" data-boardgame-id="' + id + '"><img src="/images/logo.jpg" /><h3>' + name + '</h3></a></li>');
      $('#selected_boardgames').listview('refresh');

    });
    $.each($('.pagination a'), function(){
      var href = $(this).attr('href'),
        search_term = $('#search_term').val();
      $(this).attr('data-remote', 'true')
        .attr('data-ajax', 'false')
        .attr('href', href + '&search_term=' + $('<div/>').text(search_term).html());
    });

  });
</script>

<div data-role="collapsible" data-content-theme="c" id="available-boardgames-search-area">
  <h3>Add a game outside of your collection</h3>
  <div id="available-boardgames-search-form">
    <%= render 'search' %>
  </div>
</div>